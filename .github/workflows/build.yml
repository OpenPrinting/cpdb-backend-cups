name: Build and Test

on:
  push:
    branches:
    - '**'
  pull_request:
    branches:
    - '**'

jobs:
  build-linux-run-tests:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6
    - name: show Ubuntu version
      run: cat /etc/os-release | grep PRETTY_NAME | awk -F '=' '{print $2}'
    - name: update build environment
      run: sudo apt-get update --fix-missing -y
    - name: install prerequisites
      run: |
       sudo apt-get install cups libcups2-dev libglib2.0-dev autoconf autopoint libdbus-1-dev libtool -y
    - name: Install cpdb-libs Version >= 2.0.0 
      run: |
        cd ..
        mkdir cpdb-libs
        wget https://github.com/OpenPrinting/cpdb-libs/releases/download/2.0b8/cpdb-libs-2.0b8.tar.gz
        tar -xzf cpdb-libs-2.0b8.tar.gz
        cd cpdb-libs-2.0b8
        ./autogen.sh
        ./configure --prefix=/usr --enable-shared
        make all
        sudo make install
        cd ..
        cd ..
    - name: configure 
      env:
        CC: /usr/bin/gcc
      run: ./autogen.sh && ./configure --enable-debug
    - name: make
      run: make
    - name: Run Tests
      run: make check || cat test/error_log*